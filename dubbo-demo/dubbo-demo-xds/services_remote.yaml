apiVersion: v1
kind: Service
metadata:
  name: dubbo-demo-xds-consumer-service
  labels:
    app: dubbo-demo-xds-consumer
    version: v1
    service: dubbo-demo-xds-consumer
spec:
  ports:
    - port: 50050
      targetPort: 50050
      name: tcp
    - port: 31000
      targetPort: 31000
      name: debug
  selector:
      app: dubbo-demo-xds-consumer
---
apiVersion: v1
kind: Service
metadata:
  name: dubbo-demo-xds-provider-service
  labels:
    app: dubbo-demo-xds-provider
    version: v1
    service: dubbo-demo-xds-provider
spec:
  ports:
    - port: 50051
      targetPort: 50051
      name: tcp
    - port: 31001
      targetPort: 31001
      name: debug
  selector:
    app: dubbo-demo-xds-provider

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-demo-xds-consumer
  labels:
    app: dubbo-demo-xds-consumer
    version: v1
    service: dubbo-demo-xds-consumer
spec:
  selector:
    matchLabels:
      app: dubbo-demo-xds-consumer
      version: v1
  template:
    metadata:
      annotations:
        inject.istio.io/templates: grpc-agent
        proxy.istio.io/config: '{"holdApplicationUntilProxyStarts": true}'
      labels:
        app: dubbo-demo-xds-consumer
        version: v1
    spec:
      serviceAccountName: dubbo-demo-xds-consumer
      containers:
        - name: dubbo-demo-xds-consumer
          image: registry.cn-hangzhou.aliyuncs.com/apache-dubbo/xds-demo-consumer:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 50050
            - containerPort: 31000  #for JVM remote debug
          env:
            - name: JAVA_TOOL_OPTIONS
              value: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=31000"
  replicas: 1

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-demo-xds-provider
  labels:
    app: dubbo-demo-xds-provider
    version: v1
    service: dubbo-demo-xds-provider
spec:
  selector:
    matchLabels:
      app: dubbo-demo-xds-provider
      version: v1
  template:
    metadata:
      annotations:
        inject.istio.io/templates: grpc-agent
        proxy.istio.io/config: '{"holdApplicationUntilProxyStarts": true}'
      labels:
        app: dubbo-demo-xds-provider
        version: v1
    spec:
      serviceAccountName: dubbo-demo-xds-provider
      containers:
        - name: dubbo-demo-xds-provider
          image: registry.cn-hangzhou.aliyuncs.com/apache-dubbo/xds-demo-provider:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 50051 #for JVM remote debug
            - containerPort: 31001
          env:
            - name: JAVA_TOOL_OPTIONS
              value: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=31001"

  replicas: 1

#Security configs
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dubbo-demo-xds-consumer
  labels:
    app: dubbo-demo-xds-consumer
    version: v1
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dubbo-demo-xds-provider
  labels:
    app: dubbo-demo-xds-provider
    version: v1
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dubbo-demo-xds-role-provider
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dubbo-demo-xds-role-consumer
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dubbo-demo-xds-consumer-role-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: dubbo-demo-xds-consumer
roleRef:
  kind: Role
  name: dubbo-demo-xds-role-consumer
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dubbo-demo-xds-provider-role-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: dubbo-demo-xds-provider
roleRef:
  kind: Role
  name: dubbo-demo-xds-role-provider
  apiGroup: rbac.authorization.k8s.io


